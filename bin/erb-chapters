#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../lib'

# Sample of use:
#
# ```sh
# erb-chapters src/chapters
# ```
#
# Given filepath is a filepath without extension (extension will be ``yml``)
class App < ErbApp
  self.file = __FILE__

  autoload(:YAML, 'yaml')

  def output_basepath
    param.expand_path.dirname.join(param.basename('.*'))
  end

  def variables
    {
      files: files,
      chapters: files.map { |str| str.to_s.gsub(/\.tex$/, '') },
    }
  end

  def options
    { basedir: param.basename('.*').to_s }.merge(super)
  end

  def call
    files.map(&:realpath).yield_self { super }
  end

  protected

  def param
    Pathname.new("#{arguments.fetch(0)}.yml")
  end

  # @return [Array<Pathname>]
  def files
    YAML.safe_load(param.read).map do |name|
      param.dirname.join(options.fetch(:basedir), "#{name}.tex").freeze
    end
  end
end

App.new.call if __FILE__ == $PROGRAM_NAME
